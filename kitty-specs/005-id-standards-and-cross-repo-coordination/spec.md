# Feature Specification: ID Standards and Cross-Repo Coordination

**Feature Branch**: `005-id-standards-and-cross-repo-coordination`
**Created**: 2026-02-27
**Status**: Draft

## Overview

Unified ID schema for the heliosApp ecosystem. Scope: format and generation rules for workspace_id, lane_id, session_id, terminal_id, run_id, and correlation_id; cross-repo compatibility with thegent, trace, and heliosHarness; uniqueness guarantees. This spec is a foundational dependency — it defines the identity contract that every other spec references.

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Consistent Identity Across Subsystems (Priority: P0)

As a subsystem developer, I can generate IDs using a shared library and trust they are globally unique and parseable so that entities are unambiguously identifiable across subsystem boundaries.

**Why this priority**: ID collisions or format mismatches cause silent data corruption.

**Independent Test**: Generate 1 million IDs across 8 concurrent threads, verify zero collisions, verify all match the format spec.

**Acceptance Scenarios**:

1. **Given** a call to `generateId("workspace")`, **When** the ID is returned, **Then** it matches the format `ws_{ulid}` and is globally unique.
2. **Given** IDs generated by heliosApp and thegent, **When** compared, **Then** both parse correctly and maintain uniqueness across repos.
3. **Given** a raw ID string, **When** parsed, **Then** the entity type prefix and timestamp component are extractable.

---

### User Story 2 — Correlation Tracing Across Operations (Priority: P0)

As an operator debugging a multi-step operation, I can follow a correlation_id from the originating command through all downstream events across subsystems.

**Why this priority**: Traceability is the foundation for debugging and audit.

**Acceptance Scenarios**:

1. **Given** a command with correlation_id `cor_{ulid}`, **When** it triggers downstream bus events, **Then** all events carry the same correlation_id.
2. **Given** a correlation_id, **When** queried against logs from heliosApp and trace, **Then** both repos return matching records.

---

### User Story 3 — ID Validation and Rejection (Priority: P1)

As a subsystem developer, I can validate incoming IDs and reject malformed ones before they propagate.

**Why this priority**: Early rejection prevents corrupt data from entering the system.

**Acceptance Scenarios**:

1. **Given** a well-formed ID, **When** validated, **Then** it passes with the correct entity type.
2. **Given** a malformed ID (wrong prefix, invalid ULID, truncated), **When** validated, **Then** it is rejected with a specific error indicating the failure reason.

---

### Edge Cases

- IDs generated during clock skew or NTP adjustment must remain monotonic within the same process.
- ID generation must not block on entropy exhaustion; fallback to pseudo-random with logging.
- Prefix collisions between entity types must be impossible by construction (all prefixes are distinct).
- IDs must be safe for use in URLs, filenames, and JSON without escaping.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: The system MUST define a typed ID format: `{prefix}_{ulid}` where prefix identifies entity type.
- **FR-002**: The system MUST define prefixes: `ws` (workspace), `ln` (lane), `ss` (session), `tm` (terminal), `rn` (run), `cor` (correlation).
- **FR-003**: The system MUST use ULID (Universally Unique Lexicographically Sortable Identifier) as the ID body.
- **FR-004**: The system MUST guarantee global uniqueness: zero collisions expected at 1 million IDs per second per process.
- **FR-005**: The system MUST provide a shared ID generation library usable by heliosApp, thegent, trace, and heliosHarness.
- **FR-006**: The system MUST provide ID validation that checks prefix, ULID format, and character set.
- **FR-007**: The system MUST provide ID parsing that extracts entity type and timestamp from any valid ID.
- **FR-008**: All generated IDs MUST be URL-safe, filename-safe, and JSON-safe (alphanumeric + underscore only).
- **FR-009**: The system MUST maintain monotonic ordering of IDs generated within the same process and millisecond.

### Non-Functional Requirements

- **NFR-001**: ID generation MUST complete in < 0.01ms (p95) per ID.
- **NFR-002**: ID validation MUST complete in < 0.005ms (p95) per ID.
- **NFR-003**: ID generation MUST not allocate heap memory beyond the output string.
- **NFR-004**: The shared library MUST have zero runtime dependencies beyond the standard library.

### Dependencies

- None. This is a leaf dependency with no upstream spec requirements.

## Key Entities

- **Entity ID**: Typed identifier with prefix and ULID body, uniquely identifying one entity instance.
- **Prefix Registry**: Mapping of entity types to their canonical prefixes, enforced at generation and validation.
- **Correlation ID**: Specialized entity ID (prefix `cor`) used to link related operations across subsystem boundaries.
- **ID Generator**: Shared library function producing unique, monotonic, typed IDs.
- **ID Validator**: Shared library function verifying format, prefix, and ULID integrity.

## Success Criteria *(mandatory)*

- **SC-001**: Zero collisions in 10 million ID generation test across 8 concurrent threads.
- **SC-002**: 100% of generated IDs pass format validation (prefix + ULID + character set).
- **SC-003**: Cross-repo round-trip: IDs generated by heliosApp parse correctly in thegent and trace test suites.
- **SC-004**: Malformed ID injection tests produce rejection in 100% of cases with specific error reasons.
- **SC-005**: Generation latency < 0.01ms confirmed in microbenchmarks.

## Assumptions

- ULID is chosen over UUIDv7 for lexicographic sortability and timestamp extractability.
- The shared library is published as a Bun/TypeScript package consumable by all repos in the ecosystem.
- Prefix registry is append-only; existing prefixes are never reassigned or removed.
- Clock monotonicity is handled at the ULID library level; heliosApp does not implement custom clock management.
